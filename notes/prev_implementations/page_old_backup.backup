'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import Link from 'next/link';
import { useParams, useSearchParams } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import {
  getEquationConfig,
  isValidEquationType,
  type EquationConfig
} from '@/lib/equation-types';
import {
  generateAllProblems,
  shuffleArray,
  type Problem,
} from '@/lib/problem-generator';
import { getTopicByCode } from '@/lib/supabase-v2';

// Import our new modular components
import { SessionStats } from '@/app/practice/components/SessionStats';
import { ProgressBar } from '@/app/practice/components/ProgressBar';
import { Numpad } from '@/app/practice/components/Numpad';
import { AnswerInput } from '@/app/practice/components/AnswerInput';
import { PracticeTitle } from '@/app/practice/components/PracticeTitle';
import { AnonymousBanner } from '@/app/practice/components/AnonymousBanner';

// Import our new library modules
import {
  getCurrentSession,
  submitAnswer,
  completeSession,
  getLastSessionAvgResponseTime,
  type SessionStats as SessionStatsType
} from '@/lib/session-manager';
import {
  getUserStageProgress,
  getTotalReps,
  checkStageAdvancement,
  updateTotalReps,
  getProgressToNextStage,
  getStageInfo,
  getNextStage,
  STAGES
} from '@/lib/stage-manager';

function EquationPracticeContent() {
  const { user } = useAuth();
  const params = useParams();
  const searchParams = useSearchParams();

  const topicCode = params.topic as string;
  const digits = parseInt(searchParams.get('digits') || '1');

  // Core state
  const [config, setConfig] = useState<EquationConfig | null>(null);
  const [problemSet, setProblemSet] = useState<Problem[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [currentProblem, setCurrentProblem] = useState<Problem | null>(null);
  const [answer, setAnswer] = useState('');
  const [feedback, setFeedback] = useState<'correct' | 'incorrect' | null>(null);
  const [showCongrats, setShowCongrats] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // Session and progress state
  const [sessionId, setSessionId] = useState<number | null>(null);
  const [sessionStats, setSessionStats] = useState<SessionStatsType | null>(null);
  const [topicId, setTopicId] = useState<number | null>(null);
  const [currentStage, setCurrentStage] = useState(STAGES[0]);
  const [currentStageId, setCurrentStageId] = useState(1);
  const [totalReps, setTotalReps] = useState(0);
  const [lastSessionAvg, setLastSessionAvg] = useState(0);
  const [saveStatus, setSaveStatus] = useState<'idle' | 'pending' | 'saving' | 'saved'>('idle');
  const [progressPercent, setProgressPercent] = useState(0);

  // Refs
  const problemStartTimeRef = useRef<number>(Date.now());
  const saveStatusTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  // Container dimension constants
  const MAX_CONTAINER_HEIGHT = 1600;
  const CONTAINER_ASPECT_RATIO = 0.47;

  // Validate equation type
  useEffect(() => {
    if (!isValidEquationType(topicCode)) {
      return;
    }
    const equationConfig = getEquationConfig(topicCode);
    setConfig(equationConfig);
  }, [topicCode]);

  // Initialize problem set
  const initializeProblemSet = useCallback(() => {
    if (!config) return [];

    const allProblems = generateAllProblems(digits, config);
    const shuffled = shuffleArray(allProblems);
    setProblemSet(shuffled);
    setCurrentIndex(0);
    if (shuffled.length > 0) {
      setCurrentProblem(shuffled[0]);
    }
    return shuffled;
  }, [config, digits]);

  // Load next problem
  const loadNextProblem = useCallback(async () => {
    let problems = problemSet;
    let index = currentIndex;

    // If we've reached the end of the set, complete session and restart
    if (index >= problems.length) {
      setShowCongrats(true);

      // Complete current session if exists
      if (sessionId) {
        await completeSession(sessionId);
      }

      // Reset for new set
      problems = initializeProblemSet();
      index = 0;

      setTimeout(() => {
        setShowCongrats(false);
      }, 3000);
    }

    const problem = problems[index];
    setCurrentProblem(problem);
    setAnswer('');
    setFeedback(null);
    setCurrentIndex(index + 1);

    // Reset timer for new problem
    problemStartTimeRef.current = Date.now();
  }, [problemSet, currentIndex, initializeProblemSet, sessionId]);

  // Handle answer submission
  const handleAnswerSubmission = useCallback(async (userAnswer: number) => {
    if (!config || !currentProblem) return;

    const correctAnswer = config.solve(currentProblem.num1, currentProblem.num2);
    const isCorrect = userAnswer === correctAnswer;

    if (isCorrect) {
      setFeedback('correct');

      // Track response time
      const responseTime = Date.now() - problemStartTimeRef.current;

      // Submit to session if logged in
      if (user?.id && sessionId) {
        setSaveStatus('pending');
        const newStats = await submitAnswer(sessionId, true, responseTime, lastSessionAvg);
        if (newStats) {
          setSessionStats(newStats);

          // Update total reps
          const newTotalReps = totalReps + 1;
          setTotalReps(newTotalReps);

          // Update stage progress
          if (topicId) {
            await updateTotalReps(user.id, topicId, newTotalReps);
            const newStageId = await checkStageAdvancement(user.id, topicId, currentStageId, newTotalReps);
            if (newStageId > currentStageId) {
              setCurrentStageId(newStageId);
              const newStage = getStageInfo(newStageId);
              if (newStage) {
                setCurrentStage(newStage);
              }
            }
          }

          // Update save status
          setSaveStatus('saved');
          if (saveStatusTimeoutRef.current) {
            clearTimeout(saveStatusTimeoutRef.current);
          }
          saveStatusTimeoutRef.current = setTimeout(() => {
            setSaveStatus('idle');
          }, 2000);
        }
      }

      // Remove focus and load next problem
      if (document.activeElement instanceof HTMLElement) {
        document.activeElement.blur();
      }

      setTimeout(() => {
        loadNextProblem();
      }, 200);
    } else {
      setFeedback('incorrect');

      // Submit incorrect answer if logged in
      if (user?.id && sessionId) {
        const newStats = await submitAnswer(sessionId, false);
        if (newStats) {
          setSessionStats(newStats);
        }
      }

      setTimeout(() => {
        setFeedback(null);
      }, 1500);
    }
  }, [config, currentProblem, user, sessionId, lastSessionAvg, totalReps, topicId, currentStageId, loadNextProblem]);

  // Handle number click from numpad
  const handleNumberClick = useCallback(async (num: string) => {
    if (feedback === 'correct' || !config || !currentProblem) return;

    const newAnswer = answer + num;
    setAnswer(newAnswer);

    // Auto-submit if answer length matches the correct answer
    const correctAnswer = config.solve(currentProblem.num1, currentProblem.num2);
    const userAnswer = parseInt(newAnswer);

    if (!isNaN(userAnswer) && newAnswer.length >= correctAnswer.toString().length) {
      if (userAnswer === correctAnswer) {
        await handleAnswerSubmission(userAnswer);
      }
    }
  }, [feedback, config, answer, currentProblem, handleAnswerSubmission]);

  // Handle form submission
  const handleSubmit = useCallback(async () => {
    if (!answer || !config || !currentProblem) return;

    const userAnswer = parseInt(answer);
    if (!isNaN(userAnswer)) {
      await handleAnswerSubmission(userAnswer);
    }
  }, [answer, config, currentProblem, handleAnswerSubmission]);

  // Handle clear
  const handleClear = useCallback(() => {
    setAnswer('');
  }, []);

  // Handle backspace
  const handleBackspace = useCallback(() => {
    setAnswer(prev => prev.slice(0, -1));
  }, []);

  // Handle negative toggle
  const handleNegative = useCallback(() => {
    setAnswer(prev => prev.startsWith('-') ? prev.slice(1) : '-' + prev);
  }, []);

  // Initialize session and load data
  useEffect(() => {
    async function initializeSession() {
      if (!config) return;

      try {
        if (!topicCode) {
          console.error('No topic code provided');
          setIsLoading(false);
          return;
        }

        // Load data if user is logged in
        if (user?.id) {
          // Get topic info
          const topic = await getTopicByCode(topicCode);
          if (!topic) {
            console.error('Topic not found:', topicCode);
            setIsLoading(false);
            return;
          }
          setTopicId(topic.topic_id);

          // Get stage progress first (needed for session creation)
          const progress = await getUserStageProgress(user.id, topic.topic_id);
          if (progress) {
            setCurrentStageId(progress.stage_id);
            const stage = getStageInfo(progress.stage_id);
            if (stage) {
              setCurrentStage(stage);
            }
          }

          // Get or create session with the current stage
          const sessionIdResult = await getCurrentSession(user.id, topic.topic_id, progress?.stage_id || 1);
          if (sessionIdResult) {
            setSessionId(sessionIdResult);

            // Initialize session stats
            setSessionStats({
              reps: 0,
              responseTimes: [],
              incorrectAnswers: 0,
              avgResponseTime: 0,
              medianResponseTime: 0,
              accuracy: 0
            });
          }

          // Get total reps
          const reps = await getTotalReps(user.id, topic.topic_id);
          setTotalReps(reps);

          // Get last session average
          const lastAvg = await getLastSessionAvgResponseTime(user.id, topic.topic_id);
          setLastSessionAvg(lastAvg);
        }

        // Initialize problem set
        const problems = initializeProblemSet();
        if (problems.length > 0) {
          setCurrentProblem(problems[0]);
          setCurrentIndex(1);
        }

        setIsLoading(false);
      } catch (error) {
        console.error('Error initializing session:', error);
        setIsLoading(false);
      }
    }

    initializeSession();
  }, [config, topicCode, user, initializeProblemSet]);

  // Cleanup
  useEffect(() => {
    return () => {
      if (saveStatusTimeoutRef.current) {
        clearTimeout(saveStatusTimeoutRef.current);
      }
    };
  }, []);

  // Calculate progress when dependencies change
  useEffect(() => {
    async function updateProgress() {
      if (topicId) {
        const percent = await getProgressToNextStage(topicId, currentStageId, totalReps);
        setProgressPercent(percent);
      }
    }
    updateProgress();
  }, [topicId, currentStageId, totalReps]);

  const nextStage = getNextStage(currentStageId);

  // Show error if invalid topic
  if (!isValidEquationType(topicCode)) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-zinc-900 dark:to-black flex items-center justify-center px-4">
        <div className="text-center">
          <div className="text-modal-emoji mb-4">‚ùå</div>
          <p className="text-modal-text text-zinc-600 dark:text-zinc-400 mb-4">
            Invalid topic: {topicCode}
          </p>
          <Link
            href="/practice/math"
            className="text-back-link text-blue-600 dark:text-blue-400 hover:underline"
          >
            ‚Üê Back to Math Practice
          </Link>
        </div>
      </div>
    );
  }

  if (isLoading || !config || !currentProblem) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-zinc-900 dark:to-black flex items-center justify-center px-4">
        <div className="text-center">
          <div className="text-modal-emoji mb-4">üìö</div>
          <p className="text-modal-text text-zinc-600 dark:text-zinc-400">Loading your practice session...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen flex flex-col bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-zinc-900 dark:to-black overflow-hidden">
      {/* Anonymous User Banner */}
      {!user && <AnonymousBanner />}

      {/* Save Status Indicator */}
      {user && saveStatus !== 'idle' && (
        <div className="fixed top-4 right-4 z-50">
          <div className="bg-white dark:bg-zinc-800 rounded-full px-3 py-2 shadow-lg border border-zinc-200 dark:border-zinc-700 flex items-center gap-2">
            {saveStatus === 'pending' && (
              <>
                <div className="w-2 h-2 bg-yellow-500 rounded-full"></div>
                <span className="text-xs text-zinc-600 dark:text-zinc-400">Unsaved changes</span>
              </>
            )}
            {saveStatus === 'saving' && (
              <>
                <div className="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span className="text-xs text-zinc-600 dark:text-zinc-400">Saving...</span>
              </>
            )}
            {saveStatus === 'saved' && (
              <>
                <div className="w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                  <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <span className="text-xs text-green-600 dark:text-green-400">Saved!</span>
              </>
            )}
          </div>
        </div>
      )}

      {/* Congratulations Modal */}
      {showCongrats && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4">
          <div className="bg-white dark:bg-zinc-800 rounded-xl p-8 shadow-2xl border border-zinc-200 dark:border-zinc-700 max-w-md w-full text-center animate-bounce">
            <div className="text-6xl mb-4">üéâ</div>
            <h2 className="text-2xl font-bold text-zinc-900 dark:text-white mb-2">
              Set Complete!
            </h2>
            <p className="text-lg text-zinc-600 dark:text-zinc-400 mb-4">
              You've completed all {problemSet.length} problems!
            </p>
            <p className="text-sm text-zinc-500 dark:text-zinc-400">
              Session reps: <span className="font-bold text-blue-600 dark:text-blue-400">{sessionStats?.reps || 0}</span>
            </p>
            <p className="text-sm text-zinc-500 dark:text-zinc-400">
              Total reps: <span className="font-bold text-indigo-600 dark:text-indigo-400">{totalReps}</span>
            </p>
          </div>
        </div>
      )}

      <main className="flex-1 max-w-2xl mx-auto w-full px-4 py-8 flex flex-col">
        {/* Back Link */}
        <Link
          href="/practice/math"
          className="inline-flex items-center text-blue-600 dark:text-blue-400 hover:underline mb-4"
        >
          ‚Üê Back to Math Practice
        </Link>

        {/* Title */}
        <PracticeTitle
          subject="Math"
          topic={config.title}
          subtitle={`${config.emoji} Practice`}
        />

        {/* Progress Bar */}
        {user && (
          <ProgressBar
            currentReps={totalReps}
            targetReps={nextStage ? 1000 : currentStage.id === 1 ? 1000 : 10000} // TODO: Get actual target from stage requirements
            currentStage={currentStage.code}
            nextStage={nextStage?.code}
          />
        )}

        {/* Problem Display */}
        <div className={`bg-white dark:bg-zinc-800 rounded-xl p-8 mb-4 shadow-lg border-2 transition-all duration-200 ${
          feedback === 'correct'
            ? 'border-green-500 bg-green-50 dark:bg-green-900/20'
            : 'border-zinc-200 dark:border-zinc-700'
        }`}>
          <div className="text-center text-4xl font-bold text-zinc-900 dark:text-white mb-6">
            {config.displayEquation ? (
              <>{config.displayEquation(currentProblem.num1, currentProblem.num2)} = ?</>
            ) : config.id === 'root' ? (
              <>{config.operator}{currentProblem.num1} = ?</>
            ) : (
              <>{currentProblem.num1} {config.operator} {currentProblem.num2} = ?</>
            )}
          </div>

          {/* Answer Input */}
          <div className="mb-6">
            <AnswerInput
              value={answer}
              onChange={setAnswer}
              onSubmit={handleSubmit}
              feedback={feedback}
              placeholder="Enter answer"
            />
          </div>

          {/* Numpad */}
          <Numpad
            onNumberClick={handleNumberClick}
            onClear={handleClear}
            onBackspace={config.id !== 'add_w_negatives' && config.id !== 'subtract_w_negatives' ? handleBackspace : undefined}
            onNegative={config.id === 'add_w_negatives' || config.id === 'subtract_w_negatives' ? handleNegative : undefined}
            onSubmit={handleSubmit}
            hasNegatives={config.id === 'add_w_negatives' || config.id === 'subtract_w_negatives'}
            submitDisabled={!answer}
          />
        </div>

        {/* Session Stats */}
        {sessionStats && user && (
          <SessionStats
            reps={sessionStats.reps}
            accuracy={sessionStats.accuracy}
            avgResponseTime={sessionStats.avgResponseTime}
            medianResponseTime={sessionStats.medianResponseTime}
          />
        )}
      </main>
    </div>
  );
}

export default function EquationPractice() {
  return <EquationPracticeContent />;
}