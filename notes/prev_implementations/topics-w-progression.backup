
<div className={styles.topicsSection}>
  <h2 className={styles.sectionTitle}>Topics</h2>
  <div className={styles.topicGrid}>
    {topics.map((topic) => {
      const currentStageId = topic.user_progress?.stage_id || 1;
      const icon = TOPIC_ICONS[topic.code] || 'ðŸ“š';
      const stageName = STAGE_DISPLAY_NAMES[currentStageId];

      // Get progress for current stage
      const progression = topic.difficulty_progression;
      let stageProgress = 0;
      let stageRequirement = 1000; // default

      if (progression && currentStageId <= 6) {
        const stageFields = ['hatsu', 'shu', 'kan', 'ha', 'toi', 'ri'] as const;
        const currentField = stageFields[currentStageId - 1];
        stageRequirement = progression[currentField] || 1000;
        stageProgress = calculateProgress(topic.total_reps || 0, stageRequirement);
      }

      return (
        <Link
          key={topic.topic_id}
          href={`/practice/${fieldCode}/${subjectCode}/${topic.code}?stage=${currentStageId}&difficulty=101`}
          className={styles.topicCard}
        >
          <div className={styles.topicHeader}>
            <div className={styles.topicIcon}>{icon}</div>
            <div className={styles.topicStage}>
              <div className={styles.stageKanji}>
                {stageName.split(' ')[0]}
              </div>
              <div className={styles.stageName}>
                Stage {currentStageId}
              </div>
            </div>
          </div>

          <h3 className={styles.topicTitle}>
            {topic.display_name}
          </h3>

          {/* Progress bar */}
          <div className={styles.progressWrapper}>
            <div className={styles.progressBar}>
              <div
                className={styles.progressFill}
                style={{ width: `${stageProgress}%` }}
              />
            </div>
            <div className={styles.progressText}>
              {topic.total_reps || 0} / {stageRequirement} reps
            </div>
          </div>

          {/* Stats */}
          <div className={styles.topicStats}>
            <div className={styles.statItem}>
              <span className={styles.statLabel}>Sessions:</span>
              <span className={styles.statValue}>{topic.sessions_count || 0}</span>
            </div>
            {topic.last_practiced && (
              <div className={styles.statItem}>
                <span className={styles.statLabel}>Last practiced:</span>
                <span className={styles.statValue}>
                  {new Date(topic.last_practiced).toLocaleDateString()}
                </span>
              </div>
            )}
          </div>

          {/* Difficulty options */}
          {topic.difficulty_options && topic.difficulty_options.length > 0 && (
            <div className={styles.difficultyIndicator}>
              {topic.difficulty_options.map(diff => (
                <span key={diff.difficulty_level_id} className={styles.difficultyDot}>
                  {diff.character}
                </span>
              ))}
            </div>
          )}
        </Link>
      );
    })}
  </div>
</div>
